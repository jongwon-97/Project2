<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.kosmo.nexus.mapper.BoardMapper">
    <resultMap id="BoardResultMap" type="Board">
        <result property="boardId" column="board_id"/>
        <result property="boardTitle" column="board_title"/>
        <result property="boardContent" column="board_content"/>
        <result property="boardViews" column="board_views"/>
        <result property="boardCreateDate" column="board_create_date"/>
        <result property="boardCategory" column="board_category"/>
        <result property="disclosureStatus" column="disclosure_status"/>
        <result property="answerStatus" column="answer_status"/>
        <result property="memberId" column="member_id"/>
        <result property="isNotice" column="is_notice"/> <!-- 공지 여부 매핑 -->
    </resultMap>


    <!-- 페이징된 공지사항 목록 조회(댓글 개수와 함께) -->
    <select id="selectNotificationList" parameterType="Paging" resultType="Board">
        (
        -- 공지사항 가져오기
        SELECT
        b.board_id AS boardId,
        b.board_title AS boardTitle,
        b.board_content AS boardContent,
        b.member_id AS memberId,
        b.board_create_date AS boardCreateDate,
        b.board_views AS boardViews,
        b.is_notice AS isNotice,
        (SELECT COUNT(*)
        FROM c_comment c
        WHERE c.board_id = b.board_id AND c.parent_id IS NULL) AS commentCount,
        1 AS priority
        FROM c_board b
        WHERE b.is_notice = true
        <if test="findType != null and findType == 'title'">
            AND b.board_title LIKE CONCAT('%', #{findKeyword}, '%')
        </if>
        <if test="findType != null and findType == 'member'">
            AND b.member_id LIKE CONCAT('%', #{findKeyword}, '%')
        </if>
        )
        UNION ALL
        (
        -- 일반 글 가져오기
        SELECT
        b.board_id AS boardId,
        b.board_title AS boardTitle,
        b.board_content AS boardContent,
        b.member_id AS memberId,
        b.board_create_date AS boardCreateDate,
        b.board_views AS boardViews,
        b.is_notice AS isNotice,
        (SELECT COUNT(*)
        FROM c_comment c
        WHERE c.board_id = b.board_id AND c.parent_id IS NULL) AS commentCount,
        2 AS priority
        FROM c_board b
        WHERE b.is_notice = false
        <if test="findType != null and findType == 'title'">
            AND b.board_title LIKE CONCAT('%', #{findKeyword}, '%')
        </if>
        <if test="findType != null and findType == 'member'">
            AND b.member_id LIKE CONCAT('%', #{findKeyword}, '%')
        </if>

        ORDER BY b.board_id DESC
        LIMIT #{start}, #{oneRecordPage}
        )
        ORDER BY priority ASC, boardId DESC;
    </select>

    <select id="getTotalGeneralCount" parameterType="Paging" resultType="int">
        SELECT COUNT(*)
        FROM c_board
        WHERE is_notice = false
        <if test="findType != null and findType == 'title'">
            AND board_title LIKE CONCAT('%', #{findKeyword}, '%')
        </if>
        <if test="findType != null and findType == 'member'">
            AND member_id LIKE CONCAT('%', #{findKeyword}, '%')
        </if>
    </select>

    <!-- 총 게시물 수 조회 -->
    <select id="getTotalNotificationCount" resultType="int">
        SELECT COUNT(*)
        FROM c_board
    </select>


    <!-- 공지사항 상세보기 -->
    <select id="selectNotificationById" resultMap="BoardResultMap">
        SELECT * FROM c_board WHERE board_id = #{num}
    </select>

    <insert id="insertNotification" parameterType="com.kosmo.nexus.dto.NoticeDTO" useGeneratedKeys="true" keyProperty="boardId">
        INSERT INTO c_board (board_title, board_content, board_views, board_create_date, board_category, member_id, is_notice)
        VALUES (#{boardTitle}, #{boardContent}, #{boardViews}, NOW(), '공지사항', #{memberId}, #{isNotice})
    </insert>


    <delete id="deleteNotification">
        DELETE FROM c_board WHERE board_id = #{num}
    </delete>

    <update id="updateNotification" parameterType="com.kosmo.nexus.dto.NoticeDTO">
        UPDATE c_board
        SET
        board_title = #{boardTitle},
        board_content = #{boardContent},
        is_notice = #{isNotice} <!-- 공지 여부 업데이트 -->
        WHERE board_id = #{boardId}
    </update>

    <update id="updateViewCount">
        UPDATE c_board
        SET board_views = board_views + 1
        WHERE board_id = #{num}
    </update>

    <insert id="insertBoard" parameterType="Board" useGeneratedKeys="true" keyProperty="boardId">
        INSERT INTO c_board (board_title, board_content, board_category, member_id, board_create_date)
        VALUES (#{boardTitle}, #{boardContent}, #{boardCategory}, #{memberId}, NOW())
    </insert>
</mapper>
