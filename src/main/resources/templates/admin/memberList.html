<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>사원 목록</title>
    <style>
        input {
            border: none;
        }
    </style>
</head>
<body>
<div class="main">
    <form id="actionForm" method="POST" >
    <div class="search-container">
        <!-- 간단 검색 -->
        <fieldset>
            <legend> 간단 검색 </legend>
            <div>
                <input type="text" id="simpleSearch" name ="simpleSearch" placeholder="검색어를 입력하세요"
                       th:value="${simpleSearch != null ? simpleSearch : ''}">
                <select id="searchOption" name="searchOption">
                    <option value="memberDepartment" th:selected="${searchOption == 'memberDepartment'}">부서별</option>
                    <option value="memberId" th:selected="${searchOption == 'memberId'}">ID</option>
                    <option value="memberNum" th:selected="${searchOption == 'memberNum'}">사번</option>
                    <option value="memberName" th:selected="${searchOption == 'memberName'}">이름</option>
                    <option value="memberRank" th:selected="${searchOption == 'memberRank'}">직급</option>
                </select>
                <button type="button" onclick="submitAction('search')">검색</button>
                <button type="button" onclick="window.location.href='/admin/memberList'"> 전체보기</button>
            </div>
        </fieldset>

        <fieldset>
            <legend onclick="toggleAdvancedSearch()"> 상세 검색 </legend>
            <div id="adSearch" name ="adSearch">
                <!-- 부서별 체크 박스 -->
                <div style="display: inline-block; margin-right: 10px;">
                    <label>부서</label><br>
                    <!-- Thymeleaf를 사용하여 부서 목록을 체크박스로 출력 -->
                    <div style="display: inline-block; margin-right: 10px;">
                        <input type="checkbox" id="departmentsAll"
                               name="departmentsAll" checked="checked" value="모든부서" onclick="toggleAllDepartments(); filterMembers()">
                        <label for="departmentsAll">모든 부서</label>
                    </div>
                    <div th:each="department : ${departments}"  style="display: inline-block; margin-right: 10px;">
                        <input type="checkbox" th:id="'department_' + ${department}"
                               th:name="'department'" th:value="${department}" checked="checked"
                               onclick="updateDepartmentsAllState(); filterMembers()">
                        <label th:for="'department_' + ${department}" th:text="${department}"></label>
                    </div>
                </div>

                <!-- 직급별 체크 박스 -->
                <div>
                    <label>직급</label><br>
                    <!-- 모든 직급을 선택/해제하는 체크박스 -->
                    <div style="display: inline-block; margin-right: 10px;">
                        <input type="checkbox" id="ranksAll" name="ranksAll" checked="checked" value="모든직급" onclick="toggleAllRanks(); filterMembers()">
                        <label for="ranksAll">모든 직급</label>
                    </div>
                    <div th:each="rank : ${ranks}"  style="display: inline-block; margin-right: 10px;">
                        <input type="checkbox" th:id="'rank_' + ${rank}"
                               th:name="'rank'" th:value="${rank}" checked="checked"
                               onclick="updateRanksAllState(); filterMembers()">
                        <label th:for="'rank_' + ${rank}" th:text="${rank}"></label>
                    </div>
                </div>

                <!-- 생년월일 -->
                <div>
                    <label for="birthStart">생년월일</label>
                    <input type="date" id="birthStart" name="birthStart"
                           th:value="${birthStart != null ? birthStart : ''}" required>
                    <span> ~ </span>
                    <input type="date" id="birthEnd" name="birthEnd"
                           th:value="${birthEnd != null ? birthEnd : ''}" required>
                    <button type="button" onclick="resetBirthDates()"> 생년월일 초기화</button>
                </div>

                <!-- 입사일 -->
                <div>
                    <label for="hireStart">입사일</label>
                    <input type="date" id="hireStart" name="hireStart"
                           th:value="${hireStart != null ? hireStart : ''}" required>
                    <span> ~ </span>
                    <input type="date" id="hireEnd" name="hireEnd"
                           th:value="${hireEnd != null ? hireEnd : ''}" required>
                    <button type="button" onclick="resetHireDates()"> 입사일 초기화</button>
                </div>

                <button type="button" onclick="submitAction('adSearch')">상세 검색</button>
                <button type="button" onclick="window.location.href='/admin/memberList'"> 전체보기</button>
            </div>
        </fieldset>
    </div>

    <div class="actions">
        <button type="button" onclick="submitAction('delete')" >삭제</button>
        <button type="button" >부서이동</button>
        <button type="button" >직급변경</button>
        <button type="button" >상태변경</button>
        <button type="button" onclick="location.href='/admin/addMember'" >추가하기</button>
    </div>

    <div class="table-container">
        <table style="text-align:center;">
            <thead>
            <tr>
                <th><input type="checkbox" id="selectAll" onclick="toggleSelectAll()"> </th>
                <th onclick="sortTable(1)">사번</th>
                <th>증명사진</th>
                <th onclick="sortTable(3)">이름</th>
                <th onclick="sortTable(4)">부서</th>
                <th onclick="sortTable(5)">직급</th>
                <th onclick="sortTable(6)">생년월일</th>
                <th onclick="sortTable(7)">입사일</th>
                <th onclick="sortTable(8)">휴대폰 번호</th>
                <th onclick="sortTable(9)">이메일</th>
                <th>상세보기</th>
            </tr>
            </thead>
            <tbody id="memberTableBody">
                <tr th:each="member : ${listMember}">
                    <td><input type="checkbox" name="selectedMembers" th:value="${member.memberId}" onchange="checkAllSelected()"></td>

                    <!-- 사번 -->
                    <td>
                        <input id="memberNum" name="memberNum" th:value="${member.memberNum}" readonly>
                    </td>

                    <!-- 증명사진 -->
                    <td>
                        <img id="memberImgName"
                             th:src="${member.memberImgName != null ? member.memberImgName : '/images/noidp.png'}"
                             alt="증명사진" style="width: 60px; height: 60px;">
                    </td>

                    <!-- 이름 -->
                    <td>
                        <input id="memberName" name="memberName" th:value="${member.memberName}" readonly>
                    </td>

                    <!-- 부서 -->
                    <td>
                        <input id="memberDepartment" name="memberDepartment" th:value="${member.memberDepartment}" readonly>
                    </td>

                    <!-- 직급 -->
                    <td>
                        <input id="memberRank" name="memberRank" th:value="${member.memberRank}" readonly>
                    </td>

                    <!-- 생년월일 -->
                    <td>
                        <input id="memberBirth" name="memberBirth" th:value="${member.memberBirth}" readonly>
                    </td>

                    <!-- 입사일 -->
                    <td>
                        <input id="memberStartDate" name="memberStartDate" th:value="${member.memberStartDate}" readonly>
                    </td>

                    <!-- 휴대폰 번호 -->
                    <td>
                        <input id="memberPhone" name="memberPhone" th:value="${member.memberPhone}" readonly>
                    </td>

                    <!-- 이메일 -->
                    <td>
                        <input id="memberEmail" name="memberEmail" th:value="${member.memberEmail}" readonly>
                    </td>

                    <!-- 상세보기 버튼 -->
                    <td style="text-align: center;">
                        <button type="button" onclick="goToUserPage(this)" class="view-btn" th:data-id="${member.memberId}" >상세보기</button>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
    </form>
</div>
</body>
<script>
    const selectAllCheckbox = document.getElementById("selectAll");
    const checkboxes = document.getElementsByName("selectedMembers");


    document.querySelector('form').addEventListener('keydown', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault(); // Enter 키로 인한 기본 동작(폼 제출)을 막음
        }
    });

    function toggleSelectAll() {
        checkboxes.forEach(checkbox => {
            checkbox.checked = selectAllCheckbox.checked;
        });
    }

    function checkAllSelected(){
        const allChecked = Array.from(checkboxes).every(checkbox => checkbox.checked);

        // selectAll 체크박스의 상태를 업데이트
        selectAllCheckbox.checked = allChecked;

        // 하나라도 체크되지 않았다면 selectAll 체크박스 해제
        if (!allChecked) {
            selectAllCheckbox.indeterminate = Array.from(checkboxes).some(checkbox => checkbox.checked);
        } else {
            selectAllCheckbox.indeterminate = false;  // 모든 체크박스가 체크된 경우
        }
    }

    function goToUserPage(button) {
        // 클릭된 버튼에서 data-id 값을 가져옴 (data-id에 memberId가 있음)
        const memberId = button.getAttribute('data-id');

        // memberId를 쿼리 파라미터로 URL에 추가하여 이동
        window.location.href = `/admin/userPage?id=${memberId}`;
    }

    function submitAction(actionType) {
        const form = document.forms['actionForm']; // Form element
        switch (actionType) {
            case 'delete':
                // 선택된 체크박스의 memberId 값을 폼에 추가합니다.
                const selectedMembers = document.querySelectorAll('input[name="selectedMembers"]:checked');

                // 폼에서 기존에 존재하는 hidden input들을 모두 제거
                const hiddenInputs = form.querySelectorAll('input[type="hidden"]');
                hiddenInputs.forEach(input => input.remove());

                // 선택된 항목을 form에 hidden input으로 추가
                selectedMembers.forEach(checkbox => {
                    const hiddenInput = document.createElement('input');
                    hiddenInput.type = 'hidden';
                    hiddenInput.name = 'membersDel';  // 서버에서 받을 이름
                    hiddenInput.value = checkbox.value;    // 체크된 항목의 memberId 값을 추가
                    form.appendChild(hiddenInput);
                });
                form.action = '/admin/memberDel'; // Delete action
                break;

            case 'search':
                const searchValue = document.getElementById('simpleSearch').value.trim();
                const searchOption = document.getElementById('searchOption').value;
                if (searchValue == "") {
                    alert("검색어를 입력해주세요.");
                    event.preventDefault();  // 폼 제출을 막음
                    return;
                }
                form.action = '/admin/search';       // search action
                break;

            case 'adSearch':
                // 폼에서 입력된 값 가져오기
                const birthStart = form['birthStart'].value;  // 생년월일 시작일
                const birthEnd = form['birthEnd'].value;      // 생년월일 종료일
                const hireStart = form['hireStart'].value;    // 입사일 시작일
                const hireEnd = form['hireEnd'].value;        // 입사일 종료일
                // 모든 필드가 비어있는지 확인
                if (birthStart === "" && birthEnd === "" && hireStart === "" && hireEnd === "") {
                    alert("생년월일과 입사일의 검색 범위를 입력하세요.");
                    event.preventDefault();  // 폼 제출을 막음
                    return;
                }
                //console.log(birthStart, birthEnd, hireStart, hireEnd);
                form.action = '/admin/adSearch';       // search action
                break;
        }
        form.submit(); // Submit the form
    }

    // "모든 부서" 체크박스를 클릭하면 모든 부서 체크박스의 상태를 변경하는 함수
    function toggleAllDepartments() {
        const isChecked = document.getElementById('departmentsAll').checked;  // "모든 부서" 체크박스 상태
        const departmentCheckboxes = document.querySelectorAll('[name="department"]');  // 개별 부서 체크박스들

        // 모든 부서 체크박스를 "모든 부서" 체크박스의 상태에 맞게 설정
        departmentCheckboxes.forEach(checkbox => {
            checkbox.checked = isChecked;
        });
    }

    // 개별 부서 체크박스의 상태가 변경될 때마다 "모든 부서" 체크박스의 상태를 업데이트하는 함수
    function updateDepartmentsAllState() {
        const departmentCheckboxes = document.querySelectorAll('[name="department"]');  // 개별 부서 체크박스들
        const departmentsAll = document.getElementById('departmentsAll');  // "모든 부서" 체크박스

        // 모든 부서 체크박스가 선택된 상태이면 "모든 부서" 체크박스를 선택, 아니면 해제
        const allChecked = Array.from(departmentCheckboxes).every(checkbox => checkbox.checked);

        // "모든 부서" 체크박스의 상태를 업데이트
        departmentsAll.checked = allChecked;

        // "모든 부서" 체크박스를 클릭하면 모든 부서 체크박스가 선택되거나 해제되도록
        departmentsAll.indeterminate = !allChecked && Array.from(departmentCheckboxes).some(checkbox => checkbox.checked);

        filterMembers();
    }

    // "모든 직급" 체크박스를 클릭하면 모든 직급 체크박스의 상태를 변경하는 함수
    function toggleAllRanks() {
        const isChecked = document.getElementById('ranksAll').checked;  // "모든 직급" 체크박스 상태
        const rankCheckboxes = document.querySelectorAll('[name="rank"]');  // 개별 직급 체크박스들

        // 모든 직급 체크박스를 "모든 직급" 체크박스의 상태에 맞게 설정
        rankCheckboxes.forEach(checkbox => {
            checkbox.checked = isChecked;
        });
    }

    // 개별 직급 체크박스의 상태가 변경될 때마다 "모든 직급" 체크박스의 상태를 업데이트하는 함수
    function updateRanksAllState() {
        const rankCheckboxes = document.querySelectorAll('[name="rank"]');  // 개별 직급 체크박스들
        const ranksAll = document.getElementById('ranksAll');  // "모든 직급" 체크박스

        // 모든 직급 체크박스가 선택된 상태이면 "모든 직급" 체크박스를 선택, 아니면 해제
        const allChecked = Array.from(rankCheckboxes).every(checkbox => checkbox.checked);

        // "모든 직급" 체크박스의 상태를 업데이트
        ranksAll.checked = allChecked;

        // "모든 직급" 체크박스를 클릭하면 모든 직급 체크박스가 선택되거나 해제되도록
        ranksAll.indeterminate = !allChecked && Array.from(rankCheckboxes).some(checkbox => checkbox.checked);

        filterMembers();
    }

    function filterMembers() {
        // 선택된 부서 및 직급 가져오기
        const selectedDepartments = Array.from(document.querySelectorAll('[name="department"]:checked')).map(checkbox => checkbox.value);
        const selectedRanks = Array.from(document.querySelectorAll('[name="rank"]:checked')).map(checkbox => checkbox.value);

        // 테이블의 모든 행을 순회
        const rows = document.querySelectorAll('#memberTableBody tr');

        rows.forEach(row => {
            const department = row.querySelector('[name="memberDepartment"]').value;
            const rank = row.querySelector('[name="memberRank"]').value;

            // 부서와 직급이 선택된 항목에 맞는지 체크
            if ((selectedDepartments.length === 0 || selectedDepartments.includes(department)) &&
                (selectedRanks.length === 0 || selectedRanks.includes(rank))) {
                row.style.display = ''; // 해당하는 경우 표시
            } else {
                row.style.display = 'none'; // 해당하지 않는 경우 숨김
            }
        });
    }
        let sortDirection = {};
    // 테이블 정렬 함수
    function sortTable(columnIndex) {
        const table = document.querySelector("table");
        const rows = Array.from(table.querySelectorAll("tbody tr"));

        // 각 열에 맞는 데이터 타입을 판단
        const isDateColumn = columnIndex === 6 || columnIndex === 7;  // 생년월일(6)과 입사일(7) 열은 날짜 처리
        const isTextColumn = !isDateColumn;  // 나머지 열들은 텍스트(문자열) 처리

        // 정렬 방향을 저장
        if (!sortDirection[columnIndex]) {
            sortDirection[columnIndex] = 1; // 기본적으로 오름차순
        } else {
            sortDirection[columnIndex] *= -1; // 반대로 변경 (오름차순 <-> 내림차순)
        }

        rows.sort((a, b) => {
            const inputA = a.cells[columnIndex].querySelector('input'); // 해당 셀의 input 요소
            const inputB = b.cells[columnIndex].querySelector('input');

            let valA = inputA.value.trim();
            let valB = inputB.value.trim();

            if (isDateColumn) {
                // 날짜 형식 처리 (생년월일, 입사일)
                valA = new Date(valA);
                valB = new Date(valB);
            }else if(isTextColumn) {
                // 한글과 영어를 동일하게 정렬하려면 normalize()를 사용하거나,
                // localeCompare에서 'ko' 로케일과 'base'로 민감도를 설정해준다
                valA = valA.normalize("NFD").replace(/[\u0300-\u036f]/g, "");  // 유니코드 변환 (선택적)
                valB = valB.normalize("NFD").replace(/[\u0300-\u036f]/g, "");  // 유니코드 변환 (선택적)

                // localeCompare 사용하여 비교 (정렬 방향을 고려)
                const compareResult = valA.localeCompare(valB, 'ko', { sensitivity: 'base' });
                return compareResult * sortDirection[columnIndex];
            }

            // 문자열 또는 숫자 정렬
            if (valA > valB) return sortDirection[columnIndex];
            if (valA < valB) return -sortDirection[columnIndex];
            return 0;
        });
        //console.log(rows);
        //console.log(sortDirection[columnIndex]);
        // 정렬된 행을 테이블에 다시 추가
        const tbody = table.querySelector("tbody");
        rows.forEach(row => tbody.appendChild(row));
    }

    // 상세검색 보이기 숨기기 기능
    function toggleAdvancedSearch() {
        var advancedSearchDiv = document.getElementById("adSearch");
        if (advancedSearchDiv.style.display === "none" || advancedSearchDiv.style.display === "") {
            advancedSearchDiv.style.display = "block";
        } else {
            advancedSearchDiv.style.display = "none";
        }
    }

    function resetBirthDates() {
        document.getElementById('birthStart').value = '';  // 생년월일 시작일 초기화
        document.getElementById('birthEnd').value = '';    // 생년월일 종료일 초기화
    }

    // 입사일 초기화 함수
    function resetHireDates() {
        document.getElementById('hireStart').value = '';  // 입사일 시작일 초기화
        document.getElementById('hireEnd').value = '';    // 입사일 종료일 초기화
    }
</script>
</html>