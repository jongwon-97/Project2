<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>이벤트 상세보기</title>
  <style>
    /* 헤더 스타일 */
    .event-header {
        position: relative;
        width: 100%;
        max-height: 300px; /* 원하는 높이로 조정 */
        overflow: hidden;
        margin-bottom: 20px;
    }

    /* 썸네일 이미지 */
    .event-header img {
        width: 100%;
        height: 300px;
        object-fit: cover;
        filter: brightness(70%); /* 이미지 어둡게 */
    }

    /* 제목 오버레이 */
    .event-title-overlay {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        color: white;
        font-size: 32px;
        font-weight: bold;
        text-align: center;
        text-shadow: 2px 2px 8px rgba(0, 0, 0, 0.8); /* 텍스트 그림자 */
    }

    /* 본문 스타일 */
    .event-details {
        padding: 20px;
        font-family: Arial, sans-serif;
        background-color: #ffffff;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        border-radius: 10px;
        margin-bottom: 20px;
    }

    /* 내용 컨테이너 */
    .content-container {
        padding: 20px;
    }

    /* 각 항목 스타일 */
    .content-item {
        margin-bottom: 20px;
    }

    .content-item img {
        width: 100%;
        max-width: 600px;
        border-radius: 5px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }

    .content-item p {
        font-size: 16px;
        color: #333;
        margin: 10px 0;
        padding: 10px;
        background-color: #f9f9f9;
        border-radius: 5px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }
                /* 네비게이션 스타일 */
    .sticky-nav {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        background-color: #ffffff;
        z-index: 1000;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        padding: 10px 0;
        border-bottom: 1px solid #ddd;
    }

    .sticky-nav ul {
        list-style: none;
        margin: 0;
        padding: 0;
        display: flex;
        justify-content: center;
        gap: 20px;
    }

    .sticky-nav ul li {
        display: inline-block;
    }

    .sticky-nav ul li a {
        text-decoration: none;
        font-size: 16px;
        color: #333;
        padding: 8px 16px;
        border-radius: 4px;
        transition: background-color 0.3s, color 0.3s;
    }

    .sticky-nav ul li a:hover {
        background-color: #f4f4f4;
        color: #007bff;
    }

    /* 스크롤 섹션 */
    .scroll-section {
        margin-top: 70px; /* 네비게이션 바 높이 */
        padding: 20px;
    }

    #top {
        padding-top: 100px; /* 네비게이션 바 높이 고려 */
    }
  </style>
</head>
<body>
<!-- 헤더 섹션 -->
<div id="top" class="scroll-section">
  <div class="event-header">
    <img th:src="${season.seasonThumbnail != null ? season.seasonThumbnail : '/thumbnails/noImage.jpg'}" alt="썸네일" />
    <div class="event-title-overlay">
      <h1 th:text="${season.seasonTitle}"></h1>
    </div>
  </div>
</div>
<!-- 스크롤 고정 네비게이션 바 -->
<nav class="sticky-nav">
  <ul>
    <li><a href="#eventInfo">이벤트 정보</a></li>
    <li><a href="#eventDetails">이벤트 상세보기</a></li>
    <li><a href="#comments">후기/댓글</a></li>
    <li><a href="#top">TOP</a></li>
  </ul>
</nav>
<div>
  <label for="seasonSelect">회차 선택:</label>
  <select id="seasonSelect">
    <option value="" disabled selected>회차를 선택하세요</option>
  </select>
</div>

<button id="goToDetailBtn" disabled>상세보기로 이동</button>
<!-- 본문 섹션 -->
<div id="eventInfo" class="scroll-section">
  <div class="event-details">
    <p><strong>설명:</strong> <span th:text="${season.seasonInfo}"></span></p>
    <p><strong>모집 인원:</strong> <span th:text="${season.seasonLimit}"></span></p>
    <p><strong>참가비:</strong> <span th:text="${season.seasonFee}"></span></p>
    <p><strong>시작 날짜:</strong> <span th:text="${season.seasonStartDate}"></span></p>
    <p><strong>종료 날짜:</strong> <span th:text="${season.seasonEndDate}"></span></p>
    <p><strong>상태:</strong> <span th:text="${season.seasonState}"></span></p>
    <p><strong>조회수:</strong> <span th:text="${season.seasonViews}"></span></p>
  </div>
</div>

<!-- 이미지 및 텍스트 표시 -->
<div id="eventDetails" class="scroll-section">
  <div class="content-container">
    <div th:each="content : ${contentList}" class="content-item">
      <!-- 이미지일 경우 -->
      <div th:if="${content.contentType == 'image'}">
        <img th:src="${content.imgPath}" alt="이미지" />
      </div>

      <!-- 텍스트일 경우 -->
      <div th:if="${content.contentType == 'text'}">
        <p th:text="${content.contentData}"></p>
      </div>
    </div>
  </div>
</div>

<!-- 삭제 버튼 -->
<!-- 삭제 및 수정 버튼 -->
<div th:if="${isDev}">
  <!-- 삭제 버튼 -->
  <form th:action="@{/user/board/deleteEvent/{seasonId}(seasonId=${season.seasonId})}" method="post" style="display:inline;"
        onsubmit="return confirm('이벤트를 삭제하시겠습니까?');">
    <button type="submit" class="btn delete-btn">삭제</button>
  </form>

  <!-- 수정 버튼 -->
  <a th:href="@{/user/board/updateEvent(seasonId=${season.seasonId})}">
    <form th:action="@{/user/board/editEvent/{seasonId}(seasonId=${season.seasonId})}" method="get">
      <button type="submit" class="btn edit-btn">수정</button>
    </form>
  </a>
</div>

<div>
  <a href="/user/board/eventList"><button type="button">목록으로</button></a>
</div>
<!-- -------------------------------------------------------------------------------- -->

<h2>댓글 작성</h2>
<form action="/user/board/addCommentBySeason" method="POST">
  <textarea name="commentContent" placeholder="댓글을 입력하세요" required></textarea><br>
  <input type="hidden" name="seasonId" th:value="${season.seasonId}"> <!-- season_id 전달 -->
  <!-- parentId는 댓글 작성 시 전달하지 않음 -->
  <button type="submit">등록하기</button>
</form>


<hr>

<h3>작성된 댓글</h3>
<div id="comments" class="scroll-section"></div>
<div class="comment-list" id="commentsSection">
  <ul id="commentList">
    <!-- 댓글 루프 -->
    <li class="comment-item" th:each="comment : ${commentList}">
      <!-- 댓글 정보 -->
      <div class="comment-info">
        <strong th:text="${comment.memberId}"></strong>
        <small th:text="${#temporals.format(comment.commentTime, 'yyyy-MM-dd HH:mm')}"></small>
      </div>

      <!-- 댓글 내용 -->
      <div class="comment-text">
        <span th:text="${comment.commentContent}"></span>
      </div>

      <!-- 대댓글 작성 -->
      <div class="reply-form">
        <form th:action="@{/user/board/addCommentBySeason}" method="POST">
          <textarea name="commentContent" placeholder="대댓글을 입력하세요" required></textarea>
          <input type="hidden" name="parentId" th:value="${comment.commentId}">
          <input type="hidden" name="seasonId" th:value="${season.seasonId}"> <!-- season_id 전달 -->
          <button type="submit">대댓글 등록</button>
        </form>
      </div>

      <!-- 댓글 관리 버튼 (로그인한 사용자만 표시) -->
      <div class="comment-actions" th:if="${comment.memberId == loginUser}">
        <!-- 댓글 수정 버튼 -->
        <button type="button" th:onclick="'showEditForm(' + ${comment.commentId} + ')'">댓글 수정</button>

        <!-- 댓글 삭제 버튼 -->
        <form th:action="@{/user/board/deleteComment}" method="POST" style="display: inline;">
          <input type="hidden" name="commentId" th:value="${comment.commentId}">
          <input type="hidden" name="seasonId" th:value="${season.seasonId}">
          <button type="submit">댓글 삭제</button>
        </form>
      </div>

      <!-- 댓글 수정 폼 -->
      <div th:id="'editForm_' + ${comment.commentId}" class="edit-form" style="display:none;">
        <form th:action="@{/user/board/editComment}" method="POST">
          <textarea name="commentContent" th:text="${comment.commentContent}" required></textarea>
          <input type="hidden" name="commentId" th:value="${comment.commentId}">
          <input type="hidden" name="seasonId" th:value="${season.seasonId}">
          <button type="submit">수정 완료</button>
        </form>
      </div>

      <!-- 대댓글 루프 -->
      <ul class="reply-list">
        <li class="reply-item" th:each="reply : ${comment.replies}">
          <!-- 대댓글 정보 -->
          <div class="reply-info">
            <strong th:text="${reply.memberId}"></strong>
            <small th:text="${#temporals.format(reply.commentTime, 'yyyy-MM-dd HH:mm')}"></small>
          </div>
          <div class="reply-text">
            <span th:text="${reply.commentContent}"></span>
          </div>

          <!-- 대댓글 관리 버튼 (로그인한 사용자만 표시) -->
          <div class="comment-actions"
               th:if="${comment.memberId == loginUser}">
            <!-- 수정 버튼 -->
            <button type="button" th:onclick="'showEditForm(' + ${comment.commentId} + ')'">수정</button>

            <!-- 삭제 버튼 -->
            <form th:action="@{/user/board/deleteComment}" method="POST" style="display: inline;">
              <input type="hidden" name="commentId" th:value="${comment.commentId}">
              <input type="hidden" name="seasonId" th:value="${season.seasonId}">
              <button type="submit">삭제</button>
            </form>
          </div>

          <!-- 대댓글 수정 폼 -->
          <div th:id="'editForm_' + ${reply.commentId}" class="edit-form" style="display:none;">
            <form th:action="@{/user/board/editComment}" method="POST">
              <textarea name="commentContent" th:text="${reply.commentContent}" required></textarea>
              <input type="hidden" name="commentId" th:value="${reply.commentId}">
              <input type="hidden" name="seasonId" th:value="${season.seasonId}">
              <button type="submit">수정 완료</button>
            </form>
          </div>
        </li>
      </ul>
    </li>
  </ul>
</div>

<script>
  // 수정 폼 표시/숨김 처리
function showEditForm(commentId) {
  const form = document.getElementById('editForm_' + commentId);
  form.style.display = form.style.display === 'none' ? 'block' : 'none';
}

// 대댓글 작성 폼 표시/숨김 처리
function showReplyForm(replyFormId) {
  const form = document.getElementById(replyFormId);
  form.style.display = form.style.display === 'none' ? 'block' : 'none';
}

// 페이지 로드 시 알림 메시지를 확인하고 표시
window.onload = function() {
  const alertMessage = /*[[${alertMessage}]]*/ null;  // Controller에서 전달한 메시지
  if (alertMessage) {
      alert(alertMessage);  // 메시지를 alert로 띄움
  }
};

      document.addEventListener("DOMContentLoaded", function () {
    // 현재 URL에서 seasonId 추출
    const path = window.location.pathname;
    const pathParts = path.split("/"); // URL을 "/"로 나눔
    const currentSeasonId = pathParts[pathParts.length - 1]; // 마지막 부분이 seasonId

    if (!currentSeasonId) {
        console.error("현재 URL에서 seasonId를 찾을 수 없습니다.");
        return; // seasonId가 없으면 중단
    }

    const seasonSelect = document.getElementById("seasonSelect");
    const goToDetailBtn = document.getElementById("goToDetailBtn");

    // 현재 seasonId를 기반으로 eventId 및 시즌 정보를 가져오기
    fetch(`/user/board/event/getEventIdBySeason/${currentSeasonId}`)
        .then(response => response.json())
        .then(data => {
            const eventId = data.eventId;

            // 해당 eventId의 모든 시즌 가져오기
            return fetch(`/user/board/event/seasons/${eventId}`);
        })
        .then(response => response.json())
        .then(data => {
            if (data && data.length > 0) {
                data.forEach(season => {
                    const option = document.createElement("option");
                    option.value = season.seasonId; // 시즌 ID
                    option.textContent = `${season.roundNumber}회차 - ${season.seasonTitle}`; // 회차 및 제목
                    option.selected = season.seasonId == currentSeasonId; // 현재 시즌 선택
                    seasonSelect.appendChild(option);
                });
            } else {
                alert("해당 이벤트에 등록된 회차가 없습니다.");
            }
        })
        .catch(error => console.error("회차 데이터 로드 실패:", error));

    // 회차 선택 시 버튼 활성화
    seasonSelect.addEventListener("change", function () {
        goToDetailBtn.disabled = !seasonSelect.value; // 값이 선택되면 버튼 활성화
    });

    // 상세보기 버튼 클릭 시 상세 페이지로 이동
    goToDetailBtn.addEventListener("click", function () {
        const selectedSeasonId = seasonSelect.value;
        if (selectedSeasonId) {
            window.location.href = `/user/board/event/detail/${selectedSeasonId}`;
        }
    });
});
</script>
</body>
</html>
